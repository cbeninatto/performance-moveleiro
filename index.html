<!-- v5.1 | Based on √çndices Moveleiro Dashboard v4.9.2 | ¬© Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openfield Moveleiro Performance</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{
    --bg:#dfe1e1; --card:#fff; --text:#000; --accent:#f5b95f; --accent-b:#e5be74;
    --shadow:0 3px 10px rgba(0,0,0,.08);
    /* √çndices palette */
    --green:#43a047;   /* Valor line */
    --orange:#fb8c00;  /* Quantidade bars/accents */
    --red:#e53935; --blue:#1e88e5; --purple:#8e24aa; --teal:#00bfa6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:18px 16px 56px}

  /* Header */
  .topbar{
    background:#000;color:#fff;border-bottom:4px solid var(--accent);
    padding:12px 16px;border-radius:10px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  }
  .tleft{font-weight:700;font-size:1.1rem}
  .tright{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rbtn{
    background:var(--accent);color:#000;border:1px solid var(--accent-b);
    padding:6px 12px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px
  }
  .rbtn:hover,.rbtn.active{background:#000;color:#fff;border-color:#000}
  .export{background:#fff;color:#000;border:1px solid #333}

  /* Sections */
  .section{margin:18px 0}
  .titlebar{
    background:#000;color:#fff;padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;
    display:flex;align-items:center;justify-content:space-between;user-select:none;border-left:6px solid var(--accent);
  }
  .titlebar.collapsible{cursor:pointer}
  .caret{font-size:0.9rem;opacity:.9}
  .card-wrap{overflow:hidden;transition:max-height .2s ease-in-out}
  .card{background:var(--card);border-radius:0 0 10px 10px;box-shadow:var(--shadow);padding:14px}

  /* Controls */
  .rangebar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .rangebar input[type="month"]{padding:6px 8px;border-radius:8px;border:1px solid #ccc}

  /* Metrics */
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 2px}
  .metric{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px 10px}
  .metric .k{font-size:.85rem;color:#444}
  .metric .v{font-weight:700;font-size:1.05rem}

  /* Charts */
  .chart{width:100%;height:520px}
  @media (max-width:720px){
    .chart{height:460px}
    .metrics{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="tleft">OPENFIELD MOVELEIRO PERFORMANCE ‚Äî v5.1</div>
    <div class="tright">
      <span id="updated" style="color:#fff;opacity:.9">Atualizado: ‚Äî</span>
      <button class="rbtn export">Exportar PDF</button>
    </div>
  </div>

  <!-- Vis√£o Geral -->
  <div class="section">
    <div class="titlebar">üìä Vis√£o Geral (Valor e Quantidade)</div>
    <div class="card-wrap" style="max-height:2000px">
      <div class="card">
        <div class="rangebar" id="range-total">
          <button class="rbtn" data-target="chart-total" data-range="3M">3M</button>
          <button class="rbtn" data-target="chart-total" data-range="6M">6M</button>
          <button class="rbtn" data-target="chart-total" data-range="1A">1A</button>
          <button class="rbtn" data-target="chart-total" data-range="5A">5A</button>
          <button class="rbtn active" data-target="chart-total" data-range="TUDO">Tudo</button>
          <span style="margin-left:8px;">De</span>
          <input type="month" id="from-total"/>
          <span>at√©</span>
          <input type="month" id="to-total"/>
          <button class="rbtn" onclick="applyCustom('chart-total','from-total','to-total')">Aplicar</button>
          <button class="rbtn" onclick="resetRange('chart-total')">Reset</button>
        </div>

        <div class="metrics" id="metrics-total">
          <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-total">‚Äî</div></div>
          <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-total">‚Äî</div></div>
          <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-total">‚Äî</div></div>
        </div>

        <div class="chart" id="chart-total"></div>
      </div>
    </div>
  </div>

  <!-- Faturamento por Linha -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-fatlin"><span>üí∞ Faturamento por Linha</span><span class="caret">‚ñº</span></div>
    <div id="card-fatlin" class="card-wrap" style="max-height:0">
      <div class="card">
        <div class="rangebar" id="range-fatlin">
          <button class="rbtn" data-target="chart-fatlin" data-range="3M">3M</button>
          <button class="rbtn" data-target="chart-fatlin" data-range="6M">6M</button>
          <button class="rbtn" data-target="chart-fatlin" data-range="1A">1A</button>
          <button class="rbtn" data-target="chart-fatlin" data-range="5A">5A</button>
          <button class="rbtn active" data-target="chart-fatlin" data-range="TUDO">Tudo</button>
          <span style="margin-left:8px;">De</span>
          <input type="month" id="from-fatlin"/>
          <span>at√©</span>
          <input type="month" id="to-fatlin"/>
          <button class="rbtn" onclick="applyCustom('chart-fatlin','from-fatlin','to-fatlin')">Aplicar</button>
          <button class="rbtn" onclick="resetRange('chart-fatlin')">Reset</button>
        </div>

        <div class="metrics" id="metrics-fatlin">
          <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-fatlin">‚Äî</div></div>
          <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-fatlin">‚Äî</div></div>
          <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-fatlin">‚Äî</div></div>
        </div>

        <div class="chart" id="chart-fatlin"></div>
      </div>
    </div>
  </div>

  <!-- Volume por Linha -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-vollin"><span>üì¶ Volume por Linha</span><span class="caret">‚ñº</span></div>
    <div id="card-vollin" class="card-wrap" style="max-height:0">
      <div class="card">
        <div class="rangebar" id="range-vollin">
          <button class="rbtn" data-target="chart-vollin" data-range="3M">3M</button>
          <button class="rbtn" data-target="chart-vollin" data-range="6M">6M</button>
          <button class="rbtn" data-target="chart-vollin" data-range="1A">1A</button>
          <button class="rbtn" data-target="chart-vollin" data-range="5A">5A</button>
          <button class="rbtn active" data-target="chart-vollin" data-range="TUDO">Tudo</button>
          <span style="margin-left:8px;">De</span>
          <input type="month" id="from-vollin"/>
          <span>at√©</span>
          <input type="month" id="to-vollin"/>
          <button class="rbtn" onclick="applyCustom('chart-vollin','from-vollin','to-vollin')">Aplicar</button>
          <button class="rbtn" onclick="resetRange('chart-vollin')">Reset</button>
        </div>

        <div class="metrics" id="metrics-vollin">
          <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-vollin">‚Äî</div></div>
          <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-vollin">‚Äî</div></div>
          <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-vollin">‚Äî</div></div>
        </div>

        <div class="chart" id="chart-vollin"></div>
      </div>
    </div>
  </div>

  <!-- Desempenho por Categoria -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-cats"><span>üìà Desempenho por Categoria</span><span class="caret">‚ñº</span></div>
    <div id="card-cats" class="card-wrap" style="max-height:0">
      <div class="card" id="cats-container">
        <!-- Cards por categoria ser√£o injetados aqui -->
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------- Setup & Helpers ---------------------- */
console.log("Openfield Moveleiro Performance v5.1 loaded");

const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const isMobile = () => window.innerWidth < 720;

/* Category colors (for per-line charts) */
const COLORS = {
  "Corredi√ßa Oculta":"#e53935",
  "Corredi√ßa Telesc√≥pica":"#fb8c00",
  "Dobradi√ßas":"#8e24aa",
  "Articuladores":"#43a047",
  "Rod√≠zio":"#00bfa6",
  "Pulsadores":"#1e88e5",
  "Acess√≥rios":"#546e7a"
};
/* Abbreviations for hover prefixes */
const CAT_ABBR = {
  "Corredi√ßa Oculta": "ESCON",
  "Corredi√ßa Telesc√≥pica": "TELES",
  "Dobradi√ßas": "DOBRA",
  "Articuladores": "ARTIC",
  "Rod√≠zio": "RODIZ",
  "Pulsadores": "PULSA",
  "Acess√≥rios": "ACESS"
};

function labelMonth(dt){ return PT_ABBR[dt.getMonth()]+" "+String(dt.getFullYear()).slice(-2); }
function fmtBRL(n){ return "R$ "+Number(n).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtQTD(n){ return Number(n).toLocaleString("pt-BR"); }
function ymToDate(s){ if(!s) return null; const p=s.split("-"); if(p.length!==2) return null; return new Date(parseInt(p[0]), parseInt(p[1])-1, 1); }

/* Range helpers for categorical x */
function applyRangeLabels(divId, labels, startIdx, endIdx){
  const gd = document.getElementById(divId);
  if(!gd) return;
  const s = Math.max(0, startIdx);
  const e = Math.min(labels.length-1, endIdx);
  Plotly.relayout(gd, { 'xaxis.range': [labels[s], labels[e]] });
}
function quickRange(divId, labels, key){
  const L = labels.length;
  let start = 0, end = L-1;
  if (key==='3M'){ start = Math.max(0, L-3); }
  else if (key==='6M'){ start = Math.max(0, L-6); }
  else if (key==='1A'){ start = Math.max(0, L-12); }
  else if (key==='5A'){ start = Math.max(0, L-60); }
  else if (key==='TUDO'){ start = 0; }
  applyRangeLabels(divId, labels, start, end);
  updateMetricsFromView(divId, labels);
}
function applyCustom(divId, fromId, toId){
  const f = document.getElementById(fromId).value;
  const t = document.getElementById(toId).value;
  if(!f || !t){ alert('Selecione m√™s/ano inicial e final.'); return; }
  const d1 = ymToDate(f), d2 = ymToDate(t);
  if(!d1 || !d2){ alert('Datas inv√°lidas.'); return; }
  const sLab = labelMonth(d1), eLab = labelMonth(d2);
  const labels = X_LABELS_BY_DIV[divId] || [];
  const sIdx = labels.indexOf(sLab), eIdx = labels.indexOf(eLab);
  if (sIdx<0 || eIdx<0){ alert('Per√≠odo fora do intervalo dos dados.'); return; }
  applyRangeLabels(divId, labels, Math.min(sIdx,eIdx), Math.max(sIdx,eIdx));
  updateMetricsFromView(divId, labels);
}
function resetRange(divId){
  const labels = X_LABELS_BY_DIV[divId] || [];
  if(!labels.length) return;
  applyRangeLabels(divId, labels, Math.max(0, labels.length-12), labels.length-1);
  updateMetricsFromView(divId, labels);
}
function wireRangeBar(barId){
  const bar = document.getElementById(barId);
  if(!bar) return;
  bar.querySelectorAll('.rbtn[data-range]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      bar.querySelectorAll('.rbtn[data-range]').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      const divId = btn.dataset.target;
      const labels = X_LABELS_BY_DIV[divId] || [];
      quickRange(divId, labels, btn.dataset.range);
    });
  });
}

/* Metrics */
function computeMetrics(rows, key='Valor'){
  if(!rows.length) return {varTotal:"‚Äî", medMensal:"‚Äî", vol:"‚Äî"};
  const vals = rows.map(r=>r[key]||0);
  if (vals.length<2) {
    const single = key==='Valor' ? fmtBRL(vals[0]||0) : fmtQTD(vals[0]||0);
    return {varTotal:"‚Äî", medMensal: single, vol:"‚Äî"};
  }
  const first = vals[0], last = vals[vals.length-1];
  const varTotal = (first===0)? 0 : ((last-first)/Math.abs(first))*100;
  const diffs = [];
  for(let i=1;i<vals.length;i++){
    const prev = vals[i-1];
    diffs.push(prev===0?0:((vals[i]-prev)/Math.abs(prev))*100));
  }
  const vol = diffs.length ? (diffs.reduce((a,b)=>a+Math.abs(b),0)/diffs.length) : 0;
  const medMensal = (vals.reduce((a,b)=>a+b,0)/vals.length);
  return {
    varTotal: (varTotal).toFixed(1).replace(".",",")+" %",
    medMensal: key==='Valor' ? fmtBRL(medMensal) : fmtQTD(Math.round(medMensal)),
    vol: vol.toFixed(1).replace(".",",")+" %"
  };
}
function getVisibleLabelRange(divId, labels){
  const gd = document.getElementById(divId);
  const xr = gd && gd.layout && gd.layout.xaxis && gd.layout.xaxis.range;
  if(!xr || xr.length!==2) return [0, labels.length-1];
  const sIdx = labels.indexOf(xr[0]);
  const eIdx = labels.indexOf(xr[1]);
  if (sIdx<0 || eIdx<0) return [0, labels.length-1];
  return [Math.min(sIdx,eIdx), Math.max(sIdx,eIdx)];
}
function updateMetricsFromView(divId, labels, seriesRows=null, key='Valor'){
  const [s,e] = getVisibleLabelRange(divId, labels);
  let rowsWindow=[];
  if (seriesRows && Array.isArray(seriesRows)) rowsWindow = seriesRows.slice(s, e+1);
  else if (divId==='chart-total' || divId==='chart-fatlin' || divId==='chart-vollin') rowsWindow = MONTHLY.slice(s, e+1);
  else rowsWindow = MONTHLY.slice(s, e+1);
  const m = computeMetrics(rowsWindow, key);
  if (divId==='chart-total'){ 
    document.getElementById('var-total').textContent = m.varTotal;
    document.getElementById('med-total').textContent = m.medMensal;
    document.getElementById('vol-total').textContent = m.vol;
  } else if (divId==='chart-fatlin'){
    document.getElementById('var-fatlin').textContent = m.varTotal;
    document.getElementById('med-fatlin').textContent = m.medMensal;
    document.getElementById('vol-fatlin').textContent = m.vol;
  } else if (divId==='chart-vollin'){
    document.getElementById('var-vollin').textContent = m.varTotal;
    document.getElementById('med-vollin').textContent = m.medMensal;
    document.getElementById('vol-vollin').textContent = m.vol;
  } else if (divId.startsWith('chart-')){
    const safe = divId.replace('chart-','');
    document.getElementById(`var-${safe}`).textContent = m.varTotal;
    document.getElementById(`med-${safe}`).textContent = m.medMensal;
    document.getElementById(`vol-${safe}`).textContent = m.vol;
  }
}

/* ---------------------- Data Load & Prep ---------------------- */
let RAW_ROWS=[], MONTHLY=[], MONTHLY_LABELS=[];
let MONTHLY_BY_CAT={}, CATS=[], CAT_ORDER=[];
const X_LABELS_BY_DIV = {}; // divId -> labels array used in that chart

function mapCategoria(descRaw){
  const d = (descRaw||"").toUpperCase();
  if (d.includes("ESCOND") || d.includes("SLIM MV119")) return "Corredi√ßa Oculta";
  if (d.includes("TRILHO") && (d.includes("NORMAL") || d.includes("TELE") || d.includes("TEL"))) return "Corredi√ßa Telesc√≥pica";
  if (d.includes("DOBRAD")) return "Dobradi√ßas";
  if (d.includes("PIST") || d.includes("ARTICUL")) return "Articuladores";
  if (d.includes("RODIZ")) return "Rod√≠zio";
  if (d.includes("PULSADOR") || d.includes("TIP-ON") || d.includes("TIP ON")) return "Pulsadores";
  return "Acess√≥rios";
}
function normalizeRows(rows){
  const out=[];
  rows.forEach(o=>{
    const ano = Number(o.Ano), mes = Number(o.Mes);
    if(!Number.isFinite(ano) || !Number.isFinite(mes)) return;
    out.push({
      Codigo: (o.Codigo||"").toString().trim(),
      Descricao: (o.Descricao||"").toString().trim(),
      Quantidade: Number(o.Quantidade)||0,
      Valor: Number(o.Valor)||0,
      Mes: mes, Ano: ano,
      Data: new Date(ano, mes-1, 1),
      Categoria: mapCategoria(o.Descricao)
    });
  });
  out.sort((a,b)=>a.Data-b.Data);
  return out;
}
function aggMonthly(rows){
  const map=new Map(); // key=YYYY-MM
  rows.forEach(r=>{
    const key = `${r.Ano}-${String(r.Mes).padStart(2,"0")}`;
    if(!map.has(key)) map.set(key,{Data:new Date(r.Ano,r.Mes-1,1), Valor:0, Quantidade:0});
    const m = map.get(key);
    m.Valor += Number(r.Valor)||0;
    m.Quantidade += Number(r.Quantidade)||0;
  });
  return Array.from(map.values()).sort((a,b)=>a.Data-b.Data);
}
function buildLabelsFromMonthly(monthly){
  return monthly.map(r => labelMonth(r.Data));
}
function aggMonthlyByCategoryAligned(rows, labels){
  const catsSet = new Set();
  const tmp = {}; // cat -> {label -> {Valor, Quantidade}}
  rows.forEach(r=>{
    catsSet.add(r.Categoria);
    const lab = labelMonth(r.Data);
    tmp[r.Categoria] = tmp[r.Categoria] || {};
    if(!tmp[r.Categoria][lab]) tmp[r.Categoria][lab] = {Valor:0, Quantidade:0};
    tmp[r.Categoria][lab].Valor += r.Valor;
    tmp[r.Categoria][lab].Quantidade += r.Quantidade;
  });
  const outData = {};
  Array.from(catsSet).forEach(cat=>{
    outData[cat] = labels.map(lab=>{
      const v = (tmp[cat] && tmp[cat][lab]) ? tmp[cat][lab] : {Valor:0, Quantidade:0};
      return {Label:lab, Valor:v.Valor, Quantidade:v.Quantidade};
    });
  });
  return {cats:Array.from(catsSet), data:outData};
}

/* ---------------------- Charts ---------------------- */
/* Vis√£o Geral: Green line (Valor) + Orange bars (Quantidade) with dual Y */
function drawTotal(){
  const labels = MONTHLY_LABELS.slice();
  X_LABELS_BY_DIV['chart-total'] = labels;

  const lineValor = {
    x: labels,
    y: MONTHLY.map(r=>r.Valor),
    mode:'lines+markers',
    line:{shape:'spline',smoothing:0.6,width:3,color:'var(--green)'},
    marker:{size:6,line:{width:1,color:'#fff'}},
    name:'Valor (R$)',
    yaxis:'y',
    hovertemplate:"<b>Valor: %{customdata.v}</b><extra></extra>",
    customdata: MONTHLY.map(r=>({v:fmtBRL(r.Valor)}))
  };
  const barsQtd = {
    x: labels,
    y: MONTHLY.map(r=>r.Quantidade),
    type:'bar',
    marker:{color:'var(--orange)', line:{width:0}},
    opacity:.95,
    name:'Quantidade (un.)',
    yaxis:'y2',
    hovertemplate:"<b>Quantidade: %{customdata.q} un</b><extra></extra>",
    customdata: MONTHLY.map(r=>({q:fmtQTD(r.Quantidade)}))
  };

  const layout = {
    hovermode:'x unified',
    barmode:'overlay',
    legend:{orientation:'h',y:-0.25,font:{size:isMobile()?11:12}},
    xaxis:{
      type:'category',
      categoryorder:'array',
      categoryarray: labels,
      showgrid:false,
      tickfont:{size:isMobile()?10:12},
      automargin:true
    },
    yaxis:{
      title:'Valor (R$)',
      gridcolor:'#e9ecef',
      zeroline:false,
      tickfont:{size:isMobile()?10:12},
      automargin:true,
      range:[0,5000000],
      dtick:1000000,
      tickformat: ',.0f'
    },
    yaxis2:{
      title:'Quantidade (un.)',
      overlaying:'y',
      side:'right',
      tickfont:{size:isMobile()?10:12},
      automargin:true
    },
    paper_bgcolor:'#fff', plot_bgcolor:'#fff',
    margin:{t:20,r:40,b:80,l:60}
  };

  Plotly.newPlot('chart-total',[lineValor,barsQtd],layout,{responsive:true});
  applyRangeLabels('chart-total', labels, Math.max(0, labels.length-12), labels.length-1);
  updateMetricsFromView('chart-total', labels, null, 'Valor');
  attachRelayoutSync('chart-total', labels);
}

/* Faturamento por Linha: Lines only (Valor), with prefixes in hover */
function drawRevenueLines(){
  const labels = MONTHLY_LABELS.slice();
  X_LABELS_BY_DIV['chart-fatlin'] = labels;

  const traces = CAT_ORDER.map(cat=>{
    const series = MONTHLY_BY_CAT[cat] || labels.map(l=>({Label:l,Valor:0,Quantidade:0}));
    return {
      x: labels,
      y: series.map(p=>p.Valor),
      mode:'lines+markers',
      line:{shape:'spline',smoothing:0.6,width:3,color:COLORS[cat]||'#888'},
      marker:{size:5,line:{width:1,color:'#fff'}},
      name: cat,
      yaxis:'y',
      hovertemplate:`<b>${CAT_ABBR[cat]||cat}: %{customdata.v}</b><extra></extra>`,
      customdata: series.map(p=>({v:fmtBRL(p.Valor)}))
    };
  });

  const layout = {
    hovermode:'x unified',
    legend:{orientation:'h',y:-0.25,font:{size:isMobile()?11:12}},
    xaxis:{
      type:'category', categoryorder:'array', categoryarray: labels,
      showgrid:false, tickfont:{size:isMobile()?10:12}, automargin:true
    },
    yaxis:{title:'Valor (R$)',gridcolor:'#e9ecef',zeroline:false,tickfont:{size:isMobile()?10:12}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff', margin:{t:20,r:40,b:80,l:60}
  };

  Plotly.newPlot('chart-fatlin',traces,layout,{responsive:true});
  applyRangeLabels('chart-fatlin', labels, Math.max(0, labels.length-12), labels.length-1);
  updateMetricsFromView('chart-fatlin', labels, null, 'Valor');
  attachRelayoutSync('chart-fatlin', labels);
}

/* Volume por Linha: Lines only (Quantidade), with prefixes */
function drawVolumeLines(){
  const labels = MONTHLY_LABELS.slice();
  X_LABELS_BY_DIV['chart-vollin'] = labels;

  const traces = CAT_ORDER.map(cat=>{
    const series = MONTHLY_BY_CAT[cat] || labels.map(l=>({Label:l,Valor:0,Quantidade:0}));
    return {
      x: labels,
      y: series.map(p=>p.Quantidade),
      mode:'lines+markers',
      line:{shape:'spline',smoothing:0.6,width:3,color:COLORS[cat]||'#888'},
      marker:{size:5,line:{width:1,color:'#fff'}},
      name: cat,
      yaxis:'y',
      hovertemplate:`<b>${CAT_ABBR[cat]||cat}: %{customdata.q} un</b><extra></extra>`,
      customdata: series.map(p=>({q:fmtQTD(p.Quantidade)}))
    };
  });

  const layout = {
    hovermode:'x unified',
    legend:{orientation:'h',y:-0.25,font:{size:isMobile()?11:12}},
    xaxis:{
      type:'category', categoryorder:'array', categoryarray: labels,
      showgrid:false, tickfont:{size:isMobile()?10:12}, automargin:true
    },
    yaxis:{title:'Quantidade (un.)',gridcolor:'#e9ecef',zeroline:false,tickfont:{size:isMobile()?10:12}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff', margin:{t:20,r:40,b:80,l:60}
  };

  Plotly.newPlot('chart-vollin',traces,layout,{responsive:true});
  applyRangeLabels('chart-vollin', labels, Math.max(0, labels.length-12), labels.length-1);
  updateMetricsFromView('chart-vollin', labels, null, 'Quantidade');
  attachRelayoutSync('chart-vollin', labels);
}

/* Desempenho por Categoria: Green line (Valor) + Orange bars (Quantidade), single Y */
function buildCategoryCards(containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = CAT_ORDER.map(cat=>{
    const safe = cat.replace(/\s+/g,'-').toLowerCase();
    return `
      <div class="section" style="margin:12px 0">
        <div class="titlebar collapsible" data-target="card-${safe}">
          <span>${cat}</span><span class="caret">‚ñ∂</span>
        </div>
        <div id="card-${safe}" class="card-wrap" style="max-height:0">
          <div class="card">
            <div class="rangebar" id="range-${safe}">
              <button class="rbtn" data-target="chart-${safe}" data-range="3M">3M</button>
              <button class="rbtn" data-target="chart-${safe}" data-range="6M">6M</button>
              <button class="rbtn" data-target="chart-${safe}" data-range="1A">1A</button>
              <button class="rbtn" data-target="chart-${safe}" data-range="5A">5A</button>
              <button class="rbtn active" data-target="chart-${safe}" data-range="TUDO">Tudo</button>
              <span style="margin-left:8px;">De</span>
              <input type="month" id="from-${safe}"/>
              <span>at√©</span>
              <input type="month" id="to-${safe}"/>
              <button class="rbtn" onclick="applyCustom('chart-${safe}','from-${safe}','to-${safe}')">Aplicar</button>
              <button class="rbtn" onclick="resetRange('chart-${safe}')">Reset</button>
            </div>
            <div class="metrics">
              <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-${safe}">‚Äî</div></div>
              <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-${safe}">‚Äî</div></div>
              <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-${safe}">‚Äî</div></div>
            </div>
            <div class="chart" id="chart-${safe}"></div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  // Wire per-category range bars
  CAT_ORDER.forEach(cat=>{
    const safe = cat.replace(/\s+/g,'-').toLowerCase();
    wireRangeBar(`range-${safe}`);
  });

  // Wire collapsibles
  document.querySelectorAll('.titlebar.collapsible').forEach(tb=>{
    tb.addEventListener('click', ()=>{
      const id = tb.getAttribute('data-target');
      const wrap = document.getElementById(id);
      const open = (!wrap.style.maxHeight || wrap.style.maxHeight==='0px');
      wrap.style.maxHeight = open ? '2000px' : '0';
      const caret = tb.querySelector('.caret');
      if (caret) caret.textContent = open ? '‚ñº' : '‚ñ∂';

      // lazy draw chart on open
      if (open && id.startsWith('card-') && id!=='card-fatlin' && id!=='card-vollin'){
        const chartId = id.replace('card-','chart-');
        if (!document.getElementById(chartId).dataset.rendered){
          drawCategory(chartId);
          attachRelayoutSync(chartId, MONTHLY_LABELS);
          document.getElementById(chartId).dataset.rendered = "1";
        } else {
          updateMetricsFromView(chartId, MONTHLY_LABELS);
        }
      }
    });
  });
}
function drawCategory(chartId){
  const catKey = chartId.replace('chart-','').replace(/-/g,' ');
  const proper = CAT_ORDER.find(c => c.toLowerCase() === catKey);
  if(!proper) return;

  const labels = MONTHLY_LABELS.slice();
  X_LABELS_BY_DIV[chartId] = labels;

  const series = MONTHLY_BY_CAT[proper] || labels.map(l=>({Label:l,Valor:0,Quantidade:0}));

  const valor = {
    x: labels,
    y: series.map(p=>p.Valor),
    mode:'lines+markers',
    line:{shape:'spline',smoothing:0.6,width:3,color:'var(--green)'},
    marker:{size:6,line:{width:1,color:'#fff'}},
    name:"Valor (R$)",
    hovertemplate:`<b>${CAT_ABBR[proper]||proper}: %{customdata.v}</b><extra></extra>`,
    customdata: series.map(p=>({v:fmtBRL(p.Valor)}))
  };
  const qtd = {
    x: labels,
    y: series.map(p=>p.Quantidade),
    type:'bar',
    marker:{color:'var(--orange)'},
    opacity:.95,
    name:"Quantidade (un.)",
    hovertemplate:`<b>${CAT_ABBR[proper]||proper}: %{customdata.q} un</b><extra></extra>`,
    customdata: series.map(p=>({q:fmtQTD(p.Quantidade)}))
  };

  const layout = {
    hovermode:'x unified',
    barmode:'overlay',
    legend:{orientation:'h',y:-0.25,font:{size:isMobile()?11:12}},
    xaxis:{type:'category', categoryorder:'array', categoryarray: labels, showgrid:false, tickfont:{size:isMobile()?10:12}, automargin:true},
    yaxis:{title:'Valor (R$) / Quantidade (un.)', gridcolor:'#e9ecef', zeroline:false, tickfont:{size:isMobile()?10:12}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff', margin:{t:20,r:40,b:80,l:60}
  };

  Plotly.newPlot(chartId,[valor,qtd],layout,{responsive:true});
  applyRangeLabels(chartId, labels, Math.max(0, labels.length-12), labels.length-1);
  updateMetricsFromView(chartId, labels, series, 'Valor');
}

/* Keep metrics synced on zoom/pan */
function attachRelayoutSync(divId, labels){
  const gd = document.getElementById(divId);
  if(!gd) return;
  gd.on('plotly_relayout', ()=> updateMetricsFromView(divId, labels) );
}

/* ---------------------- Boot ---------------------- */
async function initDashboard(){
  try {
    const res = await fetch('./data/relatorio_faturamento.csv');
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    RAW_ROWS = normalizeRows(parsed.data);

    if (!RAW_ROWS.length) {
      console.error("‚ö†Ô∏è CSV loaded but contains no valid rows.");
      return;
    }

    // Updated label
    const maxD = RAW_ROWS[RAW_ROWS.length - 1].Data;
    document.getElementById("updated").textContent =
      "Atualizado: " + PT_ABBR[maxD.getMonth()] + "/" + maxD.getFullYear();

    // Aggregations
    MONTHLY = aggMonthly(RAW_ROWS);
    MONTHLY_LABELS = buildLabelsFromMonthly(MONTHLY);
    const bycat = aggMonthlyByCategoryAligned(RAW_ROWS, MONTHLY_LABELS);
    CATS = bycat.cats;
    MONTHLY_BY_CAT = bycat.data;

    // Category order
    const mainSet = [
      "Corredi√ßa Oculta",
      "Corredi√ßa Telesc√≥pica",
      "Dobradi√ßas",
      "Articuladores",
      "Rod√≠zio",
      "Pulsadores"
    ];
    const others = CATS.filter(c => !mainSet.includes(c) && c !== "Acess√≥rios");
    CAT_ORDER = [
      ...mainSet.filter(c => CATS.includes(c)),
      ...(CATS.includes("Acess√≥rios") ? ["Acess√≥rios"] : []),
      ...others
    ];

    // Draw main sections (only after data is ready)
    drawTotal();
    drawRevenueLines();
    drawVolumeLines();
    buildCategoryCards("cats-container");

    // Wire range bars
    wireRangeBar("range-total");
    wireRangeBar("range-fatlin");
    wireRangeBar("range-vollin");

    console.log("‚úÖ Dashboard loaded successfully");
  } catch (err) {
    console.error("‚ùå Error loading dashboard:", err);
  }
}

// Run only after DOM and scripts are ready
document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
