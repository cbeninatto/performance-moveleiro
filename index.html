<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Performance Moveleiro — v4.9.2 Visuals • Fase 3.1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  :root{
    --bg: #dfe1e1;
    --gold: #f5b95f;
    --card: #ffffff;
    --text: #1d1f21;
    --muted:#666;
    --grid:#0000001a;
    /* categorias */
    --red:#e53935;         /* Corrediça Oculta */
    --orange:#fb8c00;      /* Corrediça Telescópica */
    --purple:#8e24aa;      /* Dobradiças */
    --green:#43a047;       /* Articuladores */
    --teal:#00897b;        /* Rodízio */
    --blue:#1e88e5;        /* Pulsadores */
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:0;
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--text);
  }
  header{
    background:#000; color:#fff; padding:14px 16px;
    display:flex; align-items:center; justify-content:space-between;
    flex-wrap:wrap; gap:10px;
  }
  header .title{ font-weight:700; letter-spacing:.2px }
  header .meta{ font-size:12px; opacity:.9 }
  main{ padding:16px; max-width:1300px; margin:0 auto; }
  .grid{
    display:grid; grid-template-columns:1fr; gap:14px;
  }
  .card{
    background:var(--card); border-radius:14px; padding:14px 16px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
  }
  .section-title{
    display:flex; align-items:center; gap:8px; margin:6px 0 8px 0;
    font-weight:700;
  }
  .pill{ background:#000; color:#fff; border-radius:999px; font-size:11px; padding:2px 8px; }
  .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn{
    border:1px solid #000; background:#000; color:#fff;
    padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
  }
  .btn.secondary{ background:#fff; color:#000; }
  .btn.active{ outline:2px solid var(--gold); }
  .spacer{ flex:1 1 auto }
  .inputs{ display:flex; gap:8px; align-items:center; }
  .inputs input[type="month"]{ padding:6px 8px; border-radius:8px; border:1px solid #ccc; background:#fff; }
  /* Quarterly cards */
  #quarterly-summary{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px; margin:10px 0 14px 0;
  }
  .quarter-card{
    background:#fff; border-radius:12px; padding:12px 14px; text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .quarter-card h4{ margin:0; font-size:14px; font-weight:700 }
  .quarter-card p{ margin:4px 0; font-size:13px; color:#333 }
  .delta.pos{ color:#1b5e20; font-weight:600 }
  .delta.neg{ color:#b71c1c; font-weight:600 }
  .delta.neu{ color:#777; font-weight:600 }
  .plot{ width:100%; height:460px; }
  details{ border:1px solid #eee; border-radius:12px; padding:10px 12px; }
  details summary{ cursor:pointer; font-weight:600 }
  footer{ text-align:center; color:#555; font-size:12px; padding:18px 0 28px 0; }
  .muted{ color:var(--muted) }
  .gold{ color:var(--gold) }
  .legend-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
</style>
</head>
<body>
<header>
  <div class="title">Performance Moveleiro — <span class="pill">Fase 3.1</span></div>
  <div class="meta">Atualizado: <span id="atualizado"></span></div>
</header>

<main>
  <div class="grid">

    <!-- VISÃO GERAL -->
    <section class="card" id="sec-visao-geral">
      <div class="section-title">
        <span>Visão Geral</span>
        <span class="pill">Valor (R$) & Quantidade (PÇS)</span>
      </div>

      <div class="toolbar">
        <button class="btn range" data-range="3M">3M</button>
        <button class="btn range" data-range="6M">6M</button>
        <button class="btn range" data-range="1A">1A</button>
        <button class="btn range" data-range="5A">5A</button>
        <button class="btn range active" data-range="TUDO">Tudo</button>
        <div class="spacer"></div>
        <div class="inputs">
          <label class="muted" for="from">De</label>
          <input type="month" id="from">
          <label class="muted" for="to">Até</label>
          <input type="month" id="to">
          <button class="btn secondary" id="applyRange">Aplicar</button>
        </div>
      </div>

      <div id="quarterly-summary"></div>
      <div id="plot-visao-geral" class="plot"></div>
    </section>

    <!-- FATURAMENTO POR CATEGORIA -->
    <section class="card" id="sec-categoria">
      <div class="section-title">
        <span>Faturamento por Categoria</span>
        <span class="pill">Barras empilhadas (Valor) + Linha total (PÇS)</span>
      </div>
      <div id="plot-categorias" class="plot"></div>
      <div class="muted" style="font-size:12px;margin-top:-6px">
        <span class="legend-dot" style="background:var(--red)"></span>Corrediça Oculta
        <span class="legend-dot" style="background:var(--orange)"></span>Corrediça Telescópica
        <span class="legend-dot" style="background:var(--purple)"></span>Dobradiças
        <span class="legend-dot" style="background:var(--green)"></span>Articuladores
        <span class="legend-dot" style="background:var(--teal)"></span>Rodízio
        <span class="legend-dot" style="background:var(--blue)"></span>Pulsadores
        <span class="legend-dot" style="background:#999"></span>Acessórios
      </div>
    </section>

    <!-- DESEMPENHO POR CATEGORIA -->
    <section class="card" id="sec-desempenho">
      <div class="section-title">
        <span>Desempenho por Categoria</span>
        <span class="pill">Individual (Valor + PÇS)</span>
      </div>
      <div id="categoria-panels"></div>
    </section>

  </div>
</main>

<footer>
  <span>Openfield • Visual padrão v4.9.2 • Acentos <span class="gold">#f5b95f</span> • Hover unificado</span>
</footer>

<script>
/* -------------------------------------------------
   Utils & Formatting
-------------------------------------------------- */
const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits:0 });
const INT = new Intl.NumberFormat('pt-BR', { maximumFractionDigits:0 });
const DATA_URL = './data/relatorio_faturamento.csv';

const PT_MONTHS = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
function monthLabel(date){
  const d = new Date(date);
  const m = PT_MONTHS[d.getUTCMonth()];
  const y = String(d.getUTCFullYear()).slice(-2);
  return `${m} ${y}`;
}
function firstDayUTC(year, month){ return new Date(Date.UTC(year, month-1, 1)); }
function endOfMonthUTC(year, month){ return new Date(Date.UTC(year, month, 0, 23,59,59)); }
function parseNumber(v){
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return v;
  const s = String(v).trim().replace(/\./g,'').replace(',','.');
  const n = Number(s);
  return isFinite(n) ? n : 0;
}

/* -------------------------------------------------
   Category Mapping
-------------------------------------------------- */
const CATS = [
  'Corrediça Oculta',
  'Corrediça Telescópica',
  'Dobradiças',
  'Articuladores',
  'Rodízio',
  'Pulsadores',
  'Acessórios'
];
const CAT_COLORS = {
  'Corrediça Oculta': 'var(--red)',
  'Corrediça Telescópica': 'var(--orange)',
  'Dobradiças': 'var(--purple)',
  'Articuladores': 'var(--green)',
  'Rodízio': 'var(--teal)',
  'Pulsadores': 'var(--blue)',
  'Acessórios': '#999999'
};
function deriveCategory(desc=''){
  const s = (desc || '').toLowerCase();
  if (/ocult/.test(s)) return 'Corrediça Oculta';
  if (/telesc|trilhos|slide/.test(s)) return 'Corrediça Telescópica';
  if (/dobradi|hinge/.test(s)) return 'Dobradiças';
  if (/articul|gas|pist|lift/.test(s)) return 'Articuladores';
  if (/rod[ií]zi|rodiz|wheel|caster/.test(s)) return 'Rodízio';
  if (/pulsad|push|toque/.test(s)) return 'Pulsadores';
  return 'Acessórios';
}

/* -------------------------------------------------
   Data Structures
-------------------------------------------------- */
let rawRows = [];
let monthly = []; // [{ano,mes,date,valor,qtd}]
let monthlyByCat = {}; // {cat: [{ano,mes,date,valor,qtd}]}
let minMonth, maxMonth;

function normalize(rows){
  // Aggregate by month (total) and by month+category
  const mapAll = new Map();
  const mapCat = new Map();

  rows.forEach(r => {
    const ano = parseInt(r.Ano, 10);
    const mes = parseInt(r.Mes, 10);
    if (!ano || !mes) return;
    const valor = parseNumber(r.Valor);
    const qtd = parseNumber(r.Quantidade);
    const date = firstDayUTC(ano, mes);
    const key = `${ano}-${String(mes).padStart(2,'0')}`;

    // all
    if (!mapAll.has(key)){
      mapAll.set(key, { ano, mes, date, valor:0, qtd:0 });
    }
    const a = mapAll.get(key);
    a.valor += valor;
    a.qtd += qtd;

    // by category
    const cat = deriveCategory(r.Descricao);
    const k2 = `${key}|${cat}`;
    if (!mapCat.has(k2)){
      mapCat.set(k2, { cat, ano, mes, date, valor:0, qtd:0 });
    }
    const c = mapCat.get(k2);
    c.valor += valor;
    c.qtd += qtd;
  });

  const listAll = Array.from(mapAll.values()).sort((x,y)=> x.date - y.date);
  const listCat = Array.from(mapCat.values()).sort((x,y)=> x.date - y.date);

  // group listCat by cat
  const byCat = {};
  listCat.forEach(row => {
    if (!byCat[row.cat]) byCat[row.cat] = [];
    byCat[row.cat].push(row);
  });

  if (listAll.length){
    minMonth = listAll[0].date;
    maxMonth = listAll[listAll.length-1].date;
  }
  return { listAll, byCat };
}

function updateAtualizado(date){
  if (!date) return;
  const m = PT_MONTHS[date.getUTCMonth()];
  const y = date.getUTCFullYear();
  document.getElementById('atualizado').textContent = `${m} ${y}`;
}

/* -------------------------------------------------
   Filtering
-------------------------------------------------- */
let currentRange = 'TUDO';
let customFrom = null, customTo = null;

function setRangeButtons(active){
  document.querySelectorAll('.btn.range').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.range === active);
  });
}

function filterByRange(range, list){
  if (!list.length) return [];
  const last = list[list.length-1].date;
  let from = list[0].date;
  if (range === '3M'){
    from = new Date(Date.UTC(last.getUTCFullYear(), last.getUTCMonth()-2, 1));
  } else if (range === '6M'){
    from = new Date(Date.UTC(last.getUTCFullYear(), last.getUTCMonth()-5, 1));
  } else if (range === '1A'){
    from = new Date(Date.UTC(last.getUTCFullYear()-1, last.getUTCMonth(), 1));
  } else if (range === '5A'){
    from = new Date(Date.UTC(last.getUTCFullYear()-5, last.getUTCMonth(), 1));
  } else if (range === 'TUDO'){
    from = list[0].date;
  }
  const to = endOfMonthUTC(last.getUTCFullYear(), last.getUTCMonth()+1);
  return list.filter(d => d.date >= from && d.date <= to);
}

function filterByCustom(list){
  if (!customFrom || !customTo) return list;
  const [yf, mf] = customFrom.split('-').map(Number);
  const [yt, mt] = customTo.split('-').map(Number);
  const fromDate = firstDayUTC(yf, mf);
  const toDate = endOfMonthUTC(yt, mt);
  return list.filter(d => d.date >= fromDate && d.date <= toDate);
}

/* -------------------------------------------------
   Quarterly Summary (Visão Geral)
-------------------------------------------------- */
function getQuarterKey(d){ const q = Math.ceil(d.mes / 3); return `${d.ano}-Q${q}`; }
function computeQuarterly(filtered){
  const map = new Map();
  filtered.forEach(d => {
    const key = getQuarterKey(d);
    if (!map.has(key)) map.set(key, { ano:d.ano, key, valor:[], qtd:[] });
    const o = map.get(key);
    o.valor.push(d.valor);
    o.qtd.push(d.qtd);
  });
  const arr = Array.from(map.values()).sort((a,b)=> a.ano - b.ano || a.key.localeCompare(b.key))
    .map(o => ({
      key:o.key,
      avgValor: o.valor.length ? o.valor.reduce((s,v)=>s+v,0)/o.valor.length : 0,
      avgQtd:   o.qtd.length ? o.qtd.reduce((s,v)=>s+v,0)/o.qtd.length : 0
    }));
  for (let i=0;i<arr.length;i++){
    if (i===0){ arr[i].delta = null; continue; }
    const prev = arr[i-1];
    arr[i].delta = (prev.avgValor === 0) ? null : ( (arr[i].avgValor - prev.avgValor) / prev.avgValor * 100 );
  }
  return arr;
}
function renderQuarterCards(qArr){
  const host = document.getElementById('quarterly-summary');
  host.innerHTML = '';
  if (!qArr.length){
    host.innerHTML = '<p class="muted" style="margin:0">Sem dados no período selecionado.</p>';
    return;
  }
  qArr.forEach(q => {
    const deltaClass = q.delta == null ? 'neu' : (q.delta >= 0 ? 'pos' : 'neg');
    const deltaText = q.delta == null ? '—' : `${q.delta>=0?'+':''}${q.delta.toFixed(1)}%`;
    const card = document.createElement('div');
    card.className = 'quarter-card';
    card.innerHTML = `
      <h4>${q.key}</h4>
      <p>Média: <strong>${BRL.format(q.avgValor)}</strong> | <strong>${INT.format(q.avgQtd)}</strong> PÇS</p>
      <p class="delta ${deltaClass}">∆ vs. Trim. Ant.: ${deltaText}</p>
    `;
    host.appendChild(card);
  });
}

/* -------------------------------------------------
   Plot Builders (Unified Hover + v4.9.2 visuals)
-------------------------------------------------- */
const baseLayout = {
  margin:{ t:10, r:24, b:40, l:56 },
  plot_bgcolor:'#fff', paper_bgcolor:'#fff',
  xaxis:{
    type:'date',
    ticklabelmode:'period',
    tickfont:{ family:'Inter', size:12, color:'#333' },
    showgrid:true, gridcolor:'rgba(0,0,0,0.1)'
  },
  yaxis:{
    rangemode:'tozero',
    gridcolor:'rgba(0,0,0,0.1)',
    titlefont:{size:12}
  },
  yaxis2:{
    rangemode:'tozero',
    overlaying:'y', side:'right',
    titlefont:{size:12}
  },
  legend:{ orientation:'h', y:-0.2, font:{family:'Inter'} },
  hovermode:'x unified',
  hoverlabel:{ bgcolor:'#000', font:{ color:'#fff', family:'Inter' } }
};

function buildVisaoGeral(filtered){
  const x = filtered.map(d => d.date.toISOString().split('T')[0]);
  const tickvals = x.slice();
  const ticktext = filtered.map(d => monthLabel(d.date));
  const custom = filtered.map(d => [BRL.format(d.valor), INT.format(d.qtd)]);

  const traceValor = {
    x, y: filtered.map(d => d.valor),
    type:'bar', name:'Valor (R$)',
    marker:{ color:'#000', line:{ color:'#f5b95f', width:1.2 } },
    customdata: custom,
    hovertemplate:"<b>%{x}</b><br>Valor: %{customdata[0]}<br>Qtd: %{customdata[1]} PÇS<extra></extra>",
    yaxis:'y1'
  };
  const traceQtd = {
    x, y: filtered.map(d => d.qtd),
    type:'scatter', mode:'lines+markers', name:'Quantidade (PÇS)',
    line:{ color:'#555', width:2 },
    marker:{ size:6, color:'#f5b95f' },
    customdata: custom,
    hovertemplate:"<b>%{x}</b><br>Valor: %{customdata[0]}<br>Qtd: %{customdata[1]} PÇS<extra></extra>",
    yaxis:'y2'
  };

  const layout = JSON.parse(JSON.stringify(baseLayout));
  layout.xaxis.tickmode='array';
  layout.xaxis.tickvals=tickvals;
  layout.xaxis.ticktext=ticktext;
  layout.yaxis.title='Valor (R$)';
  layout.yaxis2.title='Quantidade (PÇS)';

  Plotly.react('plot-visao-geral', [traceValor, traceQtd], layout, {displayModeBar:false, responsive:true});
}

function buildCategorias(filteredAll, filteredByCat){
  // Build stacked bars (Valor) per category + total Qtd line
  const x = filteredAll.map(d => d.date.toISOString().split('T')[0]);
  const tickvals = x.slice();
  const ticktext = filteredAll.map(d => monthLabel(d.date));

  // For each category, align monthly values (0 if missing)
  const catTraces = [];
  const monthKey = d => `${d.ano}-${String(d.mes).padStart(2,'0')}`;
  const monthsIndex = filteredAll.map(d => monthKey(d));
  const customUnified = filteredAll.map(d => [BRL.format(d.valor), INT.format(d.qtd)]);

  CATS.forEach(cat => {
    const arr = (filteredByCat[cat] || []);
    const map = new Map(arr.map(r => [monthKey(r), r]));
    const y = monthsIndex.map(k => (map.get(k)?.valor || 0));
    const tr = {
      x, y, type:'bar', name:cat,
      marker:{ color: CAT_COLORS[cat] },
      customdata: y.map(v => [BRL.format(v)]),
      hovertemplate:`<b>%{x}</b><br>${cat}: %{customdata[0]}<extra></extra>`,
      yaxis:'y1'
    };
    catTraces.push(tr);
  });

  const traceQtdTotal = {
    x, y: filteredAll.map(d => d.qtd),
    type:'scatter', mode:'lines+markers', name:'Quantidade Total (PÇS)',
    line:{ color:'#555', width:2 }, marker:{ size:6, color:'#f5b95f' },
    customdata: customUnified,
    hovertemplate:"<b>%{x}</b><br>Valor Total: %{customdata[0]}<br>Qtd Total: %{customdata[1]} PÇS<extra></extra>",
    yaxis:'y2'
  };

  const layout = JSON.parse(JSON.stringify(baseLayout));
  layout.barmode='stack';
  layout.xaxis.tickmode='array';
  layout.xaxis.tickvals=tickvals;
  layout.xaxis.ticktext=ticktext;
  layout.yaxis.title='Valor (R$)';
  layout.yaxis2.title='Quantidade (PÇS)';

  Plotly.react('plot-categorias', [...catTraces, traceQtdTotal], layout, {displayModeBar:false, responsive:true});
}

function buildCategoriaPanel(containerId, cat, filteredCat){
  const host = document.getElementById(containerId);
  const idPlot = `plot-${cat.replace(/\s+/g,'-').toLowerCase()}`;
  const detail = document.createElement('details');
  const sum = document.createElement('summary');
  sum.textContent = cat;
  detail.appendChild(sum);
  const div = document.createElement('div');
  div.id = idPlot; div.className = 'plot';
  detail.appendChild(div);
  host.appendChild(detail);

  // Build plot data
  const x = filteredCat.map(d => d.date.toISOString().split('T')[0]);
  const tickvals = x.slice();
  const ticktext = filteredCat.map(d => monthLabel(d.date));
  const custom = filteredCat.map(d => [BRL.format(d.valor), INT.format(d.qtd)]);

  const traceValor = {
    x, y: filteredCat.map(d => d.valor),
    type:'bar', name:`${cat} — Valor (R$)`,
    marker:{ color:'#000', line:{ color:'#f5b95f', width:1.2 } },
    customdata: custom,
    hovertemplate:"<b>%{x}</b><br>Valor: %{customdata[0]}<br>Qtd: %{customdata[1]} PÇS<extra></extra>",
    yaxis:'y1'
  };
  const traceQtd = {
    x, y: filteredCat.map(d => d.qtd),
    type:'scatter', mode:'lines+markers', name:`${cat} — Quantidade (PÇS)`,
    line:{ color:'#555', width:2 },
    marker:{ size:6, color:'#f5b95f' },
    customdata: custom,
    hovertemplate:"<b>%{x}</b><br>Valor: %{customdata[0]}<br>Qtd: %{customdata[1]} PÇS<extra></extra>",
    yaxis:'y2'
  };

  const layout = JSON.parse(JSON.stringify(baseLayout));
  layout.xaxis.tickmode='array';
  layout.xaxis.tickvals=tickvals;
  layout.xaxis.ticktext=ticktext;
  layout.yaxis.title='Valor (R$)';
  layout.yaxis2.title='Quantidade (PÇS)';

  Plotly.newPlot(idPlot, [traceValor, traceQtd], layout, {displayModeBar:false, responsive:true});
}

/* -------------------------------------------------
   Orchestration
-------------------------------------------------- */
function refresh(){
  // Filter main monthly
  let fAll = (currentRange === 'CUSTOM') ? filterByCustom(monthly) : filterByRange(currentRange, monthly);
  // Filter per category accordingly
  const fByCat = {};
  CATS.forEach(cat => {
    const list = monthlyByCat[cat] || [];
    fByCat[cat] = (currentRange === 'CUSTOM') ? filterByCustom(list) : filterByRange(currentRange, list);
  });

  // Quarterly cards from fAll
  renderQuarterCards(computeQuarterly(fAll));

  // Build charts
  buildVisaoGeral(fAll);
  buildCategorias(fAll, fByCat);

  // Rebuild Desempenho por Categoria panels
  const host = document.getElementById('categoria-panels');
  host.innerHTML = '';
  CATS.forEach(cat => {
    if ((fByCat[cat]||[]).length){
      buildCategoriaPanel('categoria-panels', cat, fByCat[cat]);
    }
  });
}

async function init(){
  try{
    const parsed = await new Promise((resolve, reject) => {
      Papa.parse(DATA_URL, {
        download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
        complete: (res)=>resolve(res.data), error:(err)=>reject(err)
      });
    });
    rawRows = parsed;
    const norm = normalize(rawRows);
    monthly = norm.listAll;
    monthlyByCat = norm.byCat;
    updateAtualizado(monthly.length ? monthly[monthly.length-1].date : null);

    // Set custom month inputs
    const fromInput = document.getElementById('from');
    const toInput = document.getElementById('to');
    if (monthly.length){
      const min = monthly[0].date;
      const max = monthly[monthly.length-1].date;
      fromInput.value = `${min.getUTCFullYear()}-${String(min.getUTCMonth()+1).padStart(2,'0')}`;
      toInput.value = `${max.getUTCFullYear()}-${String(max.getUTCMonth()+1).padStart(2,'0')}`;
    }

    refresh();
  }catch(err){
    console.error('Erro ao carregar CSV:', err);
    document.getElementById('plot-visao-geral').innerHTML =
      '<p class="muted">Erro ao carregar dados.</p>';
  }
}

// Events
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('.btn.range');
  if (!btn) return;
  currentRange = btn.dataset.range;
  setRangeButtons(currentRange);
  refresh();
});

document.getElementById('applyRange').addEventListener('click', ()=>{
  const f = document.getElementById('from').value;
  const t = document.getElementById('to').value;
  if (f && t){
    customFrom = f; customTo = t;
    currentRange = 'CUSTOM';
    setRangeButtons('');
    refresh();
  }
});

// Kickoff
init();
</script>
</body>
</html>
