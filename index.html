<!-- v4.9 | Based on Ãndices Moveleiro Dashboard v4.9.2 | Â© Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openfield Moveleiro Performance</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{
    --bg:#dfe1e1; --card:#fff; --text:#000; --accent:#f5b95f; --accent-b:#e5be74;
    --shadow:0 3px 10px rgba(0,0,0,.08);
    --red:#e53935; --blue:#1e88e5; --orange:#fb8c00; --green:#43a047; --purple:#8e24aa; --teal:#00bfa6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:18px 16px 56px}

  /* Header */
  .topbar{
    background:#000;color:#fff;border-bottom:4px solid var(--accent);
    padding:12px 16px;border-radius:10px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  }
  .tleft{font-weight:700;font-size:1.1rem}
  .tright{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rbtn{
    background:var(--accent);color:#000;border:1px solid var(--accent-b);
    padding:6px 12px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px
  }
  .rbtn:hover,.rbtn.active{background:#000;color:#fff;border-color:#000}
  .export{background:#fff;color:#000;border:1px solid #333}

  /* Sections */
  .section{margin:18px 0}
  .titlebar{
    background:#000;color:#fff;padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;
    display:flex;align-items:center;justify-content:space-between;user-select:none;border-left:6px solid var(--accent);
  }
  .titlebar.collapsible{cursor:pointer}
  .caret{font-size:0.9rem;opacity:.9}
  .card-wrap{overflow:hidden;transition:max-height .2s ease-in-out}
  .card{background:var(--card);border-radius:0 0 10px 10px;box-shadow:var(--shadow);padding:14px}

  /* Controls */
  .rangebar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .rangebar input[type="month"]{padding:6px 8px;border-radius:8px;border:1px solid #ccc}

  /* Metrics */
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 2px}
  .metric{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px 10px}
  .metric .k{font-size:.85rem;color:#444}
  .metric .v{font-weight:700;font-size:1.05rem}

  /* Charts */
  .chart{width:100%;height:520px}
  @media (max-width:720px){
    .chart{height:460px}
    .metrics{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="tleft">OPENFIELD MOVELEIRO PERFORMANCE â€” v4.9</div>
    <div class="tright">
      <span id="updated" style="color:#fff;opacity:.9">Atualizado: â€”</span>
      <button class="rbtn export">Exportar PDF</button>
    </div>
  </div>

  <!-- VisÃ£o Geral -->
  <div class="section">
    <div class="titlebar">ðŸ“Š VisÃ£o Geral (Valor e Quantidade)</div>
    <div class="card-wrap" style="max-height:2000px">
      <div class="card">
        <div class="rangebar" id="range-total">
          <button class="rbtn" data-target="chart-total" data-range="3M">3M</button>
          <button class="rbtn" data-target="chart-total" data-range="6M">6M</button>
          <button class="rbtn" data-target="chart-total" data-range="1A">1A</button>
          <button class="rbtn" data-target="chart-total" data-range="5A">5A</button>
          <button class="rbtn active" data-target="chart-total" data-range="TUDO">Tudo</button>
          <span style="margin-left:8px;">De</span>
          <input type="month" id="from-total"/>
          <span>atÃ©</span>
          <input type="month" id="to-total"/>
          <button class="rbtn" onclick="applyCustom('chart-total','from-total','to-total')">Aplicar</button>
          <button class="rbtn" onclick="resetRange('chart-total')">Reset</button>
        </div>

        <div class="metrics" id="metrics-total">
          <div class="metric"><div class="k">VariaÃ§Ã£o total</div><div class="v" id="var-total">â€”</div></div>
          <div class="metric"><div class="k">MÃ©dia mensal</div><div class="v" id="med-total">â€”</div></div>
          <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-total">â€”</div></div>
        </div>

        <div class="chart" id="chart-total"></div>
      </div>
    </div>
  </div>
</div>

<script>
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0);}
function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1);}
function addMonths(d,m){return new Date(d.getFullYear(),d.getMonth()+m,1);}
function ymToDate(s){if(!s)return null;const p=s.split("-");if(p.length!==2)return null;return new Date(parseInt(p[0]),parseInt(p[1])-1,1);}
const isMobile=()=>window.innerWidth<720;

/* Range controls */
let DATA_MIN=null,DATA_MAX=null;
function applyRangeTo(divId,start,end){const gd=document.getElementById(divId);if(!gd)return;Plotly.relayout(gd,{'xaxis.range':[start,end]});}
function quick(divId,key){
 let start,end=endOfMonth(DATA_MAX);
 if(key==='3M')start=startOfMonth(addMonths(DATA_MAX,-2));
 else if(key==='6M')start=startOfMonth(addMonths(DATA_MAX,-5));
 else if(key==='1A')start=startOfMonth(addMonths(DATA_MAX,-11));
 else if(key==='5A')start=startOfMonth(addMonths(DATA_MAX,-59));
 else if(key==='TUDO'){start=startOfMonth(DATA_MIN);end=endOfMonth(DATA_MAX);}
 else start=startOfMonth(addMonths(DATA_MAX,-11));
 applyRangeTo(divId,start,end);
}
function applyCustom(divId,fromId,toId){
 const f=document.getElementById(fromId).value,t=document.getElementById(toId).value;
 const d1=ymToDate(f),d2=ymToDate(t);
 if(!d1||!d2){alert('Selecione mÃªs/ano inicial e final.');return;}
 applyRangeTo(divId,startOfMonth(d1),endOfMonth(d2));
}
function resetRange(divId){quick(divId,'1A');}
function wireRangeBar(barId){
 const bar=document.getElementById(barId);if(!bar)return;
 bar.querySelectorAll('.rbtn[data-range]').forEach(btn=>{
   btn.addEventListener('click',()=>{
     bar.querySelectorAll('.rbtn[data-range]').forEach(x=>x.classList.remove('active'));
     btn.classList.add('active');
     quick(btn.dataset.target,btn.dataset.range);
   });
 });
}

/* Metrics */
function computeMetrics(rows,key='Valor'){
 if(!rows.length)return{varTotal:"â€”",medMensal:"â€”",vol:"â€”"};
 const vals=rows.map(r=>r[key]||0);
 if(vals.length<2)return{varTotal:"â€”",medMensal:fmtBRL(vals[0]||0),vol:"â€”"};
 const first=vals[0],last=vals[vals.length-1];
 const varTotal=(first===0)?0:((last-first)/Math.abs(first))*100;
 const diffs=[];for(let i=1;i<vals.length;i++)diffs.push((vals[i-1]===0)?0:((vals[i]-vals[i-1])/Math.abs(vals[i-1])*100));
 const vol=diffs.length?(diffs.reduce((a,b)=>a+Math.abs(b),0)/diffs.length):0;
 const medMensal=(vals.reduce((a,b)=>a+b,0)/vals.length);
 return{varTotal:(varTotal).toFixed(1).replace(".",",")+" %",medMensal:fmtBRL(medMensal),vol:vol.toFixed(1).replace(".",",")+" %"};
}
function fmtBRL(n){return "R$ "+n.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});}

/* ---------------- NORMALIZE + AGGREGATE ---------------- */
function normalizeRows(rows){
 const out=[];
 rows.forEach(o=>{
   const ano=parseInt(o.Ano||"",10);
   const mes=parseInt(o.Mes||"",10);
   if(!Number.isFinite(ano)||!Number.isFinite(mes))return;
   out.push({
     Codigo:(o.Codigo||"").trim(),
     Descricao:(o.Descricao||"").trim(),
     Quantidade:Number(o.Quantidade)||0,
     Valor:Number(o.Valor)||0,
     Mes:mes,Ano:ano,Data:new Date(ano,mes-1,1)
   });
 });
 out.sort((a,b)=>a.Data-b.Data);
 return out;
}
function aggMonthly(rows){
 const map=new Map();
 rows.forEach(r=>{
   const key=`${r.Ano}-${String(r.Mes).padStart(2,"0")}`;
   if(!map.has(key))map.set(key,{Data:new Date(r.Ano,r.Mes-1,1),Valor:0,Quantidade:0});
   const m=map.get(key);
   m.Valor+=Number(r.Valor)||0;
   m.Quantidade+=Number(r.Quantidade)||0;
 });
 return Array.from(map.values()).sort((a,b)=>a.Data-b.Data);
}

/* ---------------- VISÃƒO GERAL ---------------- */
function drawTotal(){
 if(!MONTHLY.length)return;
 MONTHLY.sort((a,b)=>a.Data-b.Data);
 const x=MONTHLY.map(r=>r.Data.toISOString().slice(0,10));
 const minDate=MONTHLY[0].Data,maxDate=MONTHLY[MONTHLY.length-1].Data;

 const tickvals=[],ticktext=[];
 for(let i=0;i<MONTHLY.length;i++){
   const dt=MONTHLY[i].Data;
   if(dt.getMonth()%2===1){
     tickvals.push(dt.toISOString().slice(0,10));
     ticktext.push(PT_ABBR[dt.getMonth()]+" "+String(dt.getFullYear()).slice(-2));
   }
 }

 const barsValor={
   x,
   y:MONTHLY.map(r=>r.Valor),
   type:'bar',
   marker:{color:'var(--red)',opacity:0.75},
   name:'Valor (R$)',
   yaxis:'y',
   hovertemplate:"<b>%{x}</b><br>Valor: %{customdata.v}<extra></extra>",
   customdata:MONTHLY.map(r=>({v:new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(r.Valor)}))
 };
 const lineQtd={
   x,
   y:MONTHLY.map(r=>r.Quantidade),
   mode:'lines+markers',
   line:{shape:'spline',width:3,color:'var(--blue)',smoothing:0.6},
   marker:{size:6,line:{width:1,color:'#fff'}},
   name:'Quantidade (un.)',
   yaxis:'y2',
   hovertemplate:"<b>%{x}</b><br>Quantidade: %{customdata.q} un<extra></extra>",
   customdata:MONTHLY.map(r=>({q:new Intl.NumberFormat('pt-BR').format(r.Quantidade)}))
 };

 const layout={
   hovermode:'x unified',
   legend:{orientation:'h',y:-0.25,font:{size:isMobile()?11:12}},
   xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext,range:[minDate,maxDate],tickfont:{size:isMobile()?10:12},automargin:true},
   yaxis:{title:'Valor (R$)',gridcolor:'#e9ecef',zeroline:false,tickfont:{size:isMobile()?10:12},automargin:true},
   yaxis2:{title:'Quantidade (un.)',overlaying:'y',side:'right',tickfont:{size:isMobile()?10:12},automargin:true},
   paper_bgcolor:'#fff',plot_bgcolor:'#fff',margin:{t:20,r:40,b:80,l:60}
 };

 Plotly.newPlot('chart-total',[barsValor,lineQtd],layout,{responsive:true});
 Plotly.relayout('chart-total',{'xaxis.range':[minDate,maxDate]});
 const m=computeMetrics(MONTHLY,'Valor');
 document.getElementById('var-total').textContent=m.varTotal;
 document.getElementById('med-total').textContent=m.medMensal;
 document.getElementById('vol-total').textContent=m.vol;
}

/* ---------------- BOOT ---------------- */
let RAW_ROWS=[],MONTHLY=[];
(async function(){
 const res=await fetch('data/relatorio_faturamento.csv');
 const text=await res.text();
 const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
 RAW_ROWS=normalizeRows(parsed.data);
 console.log("âœ… CSV carregado:",RAW_ROWS.length,"linhas");
 MONTHLY=aggMonthly(RAW_ROWS);
 DATA_MIN=MONTHLY[0]?.Data||new Date();
 DATA_MAX=MONTHLY[MONTHLY.length-1]?.Data||new Date();
 const maxD=DATA_MAX;
 document.getElementById("updated").textContent="Atualizado: "+PT_ABBR[maxD.getMonth()]+"/"+maxD.getFullYear();
 drawTotal();
 wireRangeBar('range-total');
})();
</script>
</body>
</html>
