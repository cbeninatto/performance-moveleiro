<!-- v5.2.1 | Based on √çndices Moveleiro Dashboard v4.9.2 | ¬© Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openfield Moveleiro Performance</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{
    --bg:#dfe1e1; --card:#fff; --text:#000; --accent:#f5b95f; --accent-b:#e5be74;
    --shadow:0 3px 10px rgba(0,0,0,.08);
    /* √çndices palette */
    --orange:#fb8c00;  /* Quantidade */
    --green:#43a047;   /* Valor */
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:18px 16px 56px}

  /* Header */
  .topbar{
    background:#000;color:#fff;border-bottom:4px solid var(--accent);
    padding:12px 16px;border-radius:10px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  }
  .tleft{font-weight:700;font-size:1.1rem}
  .tright{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rbtn{
    background:var(--accent);color:#000;border:1px solid var(--accent-b);
    padding:6px 12px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px
  }
  .rbtn:hover,.rbtn.active{background:#000;color:#fff;border-color:#000}
  .export{background:#fff;color:#000;border:1px solid #333}

  /* Sections */
  .section{margin:18px 0}
  .titlebar{
    background:#000;color:#fff;padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;
    display:flex;align-items:center;justify-content:space-between;user-select:none;border-left:6px solid var(--accent);
  }
  .titlebar.collapsible{cursor:pointer}
  .caret{font-size:0.9rem;opacity:.9}
  .card-wrap{overflow:hidden;transition:max-height .25s ease}
  .card{background:var(--card);border-radius:0 0 10px 10px;box-shadow:var(--shadow);padding:14px}

  /* Controls */
  .rangebar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .rangebar input[type="month"]{padding:6px 8px;border-radius:8px;border:1px solid #ccc}

  /* Metrics */
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 2px}
  .metric{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px 10px}
  .metric .k{font-size:.85rem;color:#444}
  .metric .v{font-weight:700;font-size:1.05rem}

  /* Charts */
  .chart{width:100%;height:520px}
  @media (max-width:720px){
    .chart{height:460px}
    .metrics{grid-template-columns:1fr}
  }

  /* Loading overlay */
  #loading-overlay {
    position: fixed; inset: 0; background: rgba(255,255,255,0.95);
    z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;
    transition: opacity .6s ease, visibility .6s ease;
  }
  .loading-box {text-align:center; color:#000; font-weight:600}
  .spinner {width:48px;height:48px;border:4px solid #ddd;border-top:4px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
  .loading-text {font-size:1.1rem;color:#333}
  @keyframes spin {from{transform:rotate(0)} to{transform:rotate(360deg)}}
  .hidden {opacity:0; visibility:hidden;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="tleft">OPENFIELD MOVELEIRO PERFORMANCE ‚Äî v5.2.1</div>
      <div class="tright">
        <span id="updated" style="color:#fff;opacity:.9">Atualizado: ‚Äî</span>
        <button class="rbtn export" title="placeholder">Exportar PDF</button>
      </div>
    </div>

    <!-- Vis√£o Geral -->
    <div class="section">
      <div class="titlebar">üìä Vis√£o Geral (Valor e Quantidade)</div>
      <div class="card-wrap" style="max-height:none;overflow:visible">
        <div class="card">
          <div class="rangebar" id="range-total">
            <button class="rbtn" data-target="chart-total" data-range="3M">3M</button>
            <button class="rbtn" data-target="chart-total" data-range="6M">6M</button>
            <button class="rbtn" data-target="chart-total" data-range="1A">1A</button>
            <button class="rbtn" data-target="chart-total" data-range="5A">5A</button>
            <button class="rbtn active" data-target="chart-total" data-range="TUDO">Tudo</button>
            <span style="margin-left:8px;">De</span>
            <input type="month" id="from-total"/>
            <span>at√©</span>
            <input type="month" id="to-total"/>
            <button class="rbtn" onclick="applyCustom('chart-total','from-total','to-total')">Aplicar</button>
            <button class="rbtn" onclick="resetRange('chart-total')">Reset</button>
          </div>
          <div class="metrics" id="metrics-total">
            <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-total">‚Äî</div></div>
            <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-total">‚Äî</div></div>
            <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-total">‚Äî</div></div>
          </div>
          <div class="chart" id="chart-total"></div>
        </div>
      </div>
    </div>

    <!-- Faturamento por Linha -->
    <div class="section">
      <div class="titlebar collapsible" data-target="card-fatlin"><span>üí∞ Faturamento por Linha</span><span class="caret">‚ñ∂</span></div>
      <div id="card-fatlin" class="card-wrap" style="max-height:0;overflow:hidden">
        <div class="card">
          <div class="rangebar" id="range-fatlin">
            <button class="rbtn" data-target="chart-fatlin" data-range="3M">3M</button>
            <button class="rbtn" data-target="chart-fatlin" data-range="6M">6M</button>
            <button class="rbtn" data-target="chart-fatlin" data-range="1A">1A</button>
            <button class="rbtn" data-target="chart-fatlin" data-range="5A">5A</button>
            <button class="rbtn active" data-target="chart-fatlin" data-range="TUDO">Tudo</button>
            <span style="margin-left:8px;">De</span>
            <input type="month" id="from-fatlin"/>
            <span>at√©</span>
            <input type="month" id="to-fatlin"/>
            <button class="rbtn" onclick="applyCustom('chart-fatlin','from-fatlin','to-fatlin')">Aplicar</button>
            <button class="rbtn" onclick="resetRange('chart-fatlin')">Reset</button>
          </div>
          <div class="metrics" id="metrics-fatlin">
            <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-fatlin">‚Äî</div></div>
            <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-fatlin">‚Äî</div></div>
            <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-fatlin">‚Äî</div></div>
          </div>
          <div class="chart" id="chart-fatlin"></div>
        </div>
      </div>
    </div>

    <!-- Volume por Linha -->
    <div class="section">
      <div class="titlebar collapsible" data-target="card-vollin"><span>üì¶ Volume por Linha</span><span class="caret">‚ñ∂</span></div>
      <div id="card-vollin" class="card-wrap" style="max-height:0;overflow:hidden">
        <div class="card">
          <div class="rangebar" id="range-vollin">
            <button class="rbtn" data-target="chart-vollin" data-range="3M">3M</button>
            <button class="rbtn" data-target="chart-vollin" data-range="6M">6M</button>
            <button class="rbtn" data-target="chart-vollin" data-range="1A">1A</button>
            <button class="rbtn" data-target="chart-vollin" data-range="5A">5A</button>
            <button class="rbtn active" data-target="chart-vollin" data-range="TUDO">Tudo</button>
            <span style="margin-left:8px;">De</span>
            <input type="month" id="from-vollin"/>
            <span>at√©</span>
            <input type="month" id="to-vollin"/>
            <button class="rbtn" onclick="applyCustom('chart-vollin','from-vollin','to-vollin')">Aplicar</button>
            <button class="rbtn" onclick="resetRange('chart-vollin')">Reset</button>
          </div>
          <div class="metrics" id="metrics-vollin">
            <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-vollin">‚Äî</div></div>
            <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-vollin">‚Äî</div></div>
            <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-vollin">‚Äî</div></div>
          </div>
          <div class="chart" id="chart-vollin"></div>
        </div>
      </div>
    </div>

    <!-- Participa√ß√£o por Linha (%) -->
    <div class="section">
      <div class="titlebar collapsible" data-target="card-share"><span>üß© Participa√ß√£o por Linha (%)</span><span class="caret">‚ñ∂</span></div>
      <div id="card-share" class="card-wrap" style="max-height:0;overflow:hidden">
        <div class="card">
          <div class="rangebar" id="range-share">
            <button class="rbtn" data-target="chart-share" data-range="3M">3M</button>
            <button class="rbtn" data-target="chart-share" data-range="6M">6M</button>
            <button class="rbtn" data-target="chart-share" data-range="1A">1A</button>
            <button class="rbtn" data-target="chart-share" data-range="5A">5A</button>
            <button class="rbtn active" data-target="chart-share" data-range="TUDO">Tudo</button>
            <span style="margin-left:8px;">De</span>
            <input type="month" id="from-share"/>
            <span>at√©</span>
            <input type="month" id="to-share"/>
            <button class="rbtn" onclick="applyCustom('chart-share','from-share','to-share')">Aplicar</button>
            <button class="rbtn" onclick="resetRange('chart-share')">Reset</button>
          </div>
          <div class="metrics" id="metrics-share">
            <div class="metric"><div class="k">Maior participa√ß√£o (√∫ltimo m√™s)</div><div class="v" id="max-share">‚Äî</div></div>
            <div class="metric"><div class="k">M√©dia de participa√ß√£o (per√≠odo)</div><div class="v" id="avg-share">‚Äî</div></div>
            <div class="metric"><div class="k">Volatilidade m√©dia</div><div class="v" id="vol-share">‚Äî</div></div>
          </div>
          <div class="chart" id="chart-share"></div>
        </div>
      </div>
    </div>

    <!-- Desempenho por Linha -->
    <div class="section">
      <div class="titlebar collapsible" data-target="card-cats"><span>üìà Desempenho por Linha</span><span class="caret">‚ñ∂</span></div>
      <div id="card-cats" class="card-wrap" style="max-height:0;overflow:hidden">
        <div class="card" id="cats-container">
          <!-- Cards por linha ser√£o injetados aqui -->
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <div class="loading-text">Carregando dados‚Ä¶</div>
    </div>
  </div>

<script>
/* ====================== Helpers & Globals ====================== */
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const COLORS = {
  "Corredi√ßa Oculta":"#43a047",
  "Corredi√ßa Telesc√≥pica":"#8e24aa",
  "Dobradi√ßas":"#1e88e5",
  "Articuladores":"#fb8c00",
  "Rod√≠zio":"#00bfa6",
  "Pulsadores":"#e53935",
  "Acess√≥rios":"#6d4c41"
};
const CAT_ABBR = {
  "Corredi√ßa Oculta":"ESCON",
  "Corredi√ßa Telesc√≥pica":"TELES",
  "Dobradi√ßas":"DOBRA",
  "Articuladores":"ARTIC",
  "Rod√≠zio":"RODIZ",
  "Pulsadores":"PULSA",
  "Acess√≥rios":"ACESS"
};
const isMobile = () => window.innerWidth < 720;

let RAW_ROWS=[], MONTHLY=[], MONTHLY_BY_CAT={}, CATS=[], CAT_ORDER=[];
let MONTHLY_LABELS=[]; // aligned YYYY-MM-01
let DATA_MIN=null, DATA_MAX=null;

/* --------- Utils --------- */
function fmtBRL(n){return "R$ " + Number(n||0).toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});}
function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0);}
function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1);}
function addMonths(d, m){return new Date(d.getFullYear(), d.getMonth()+m, 1);}
function ymToDate(s){if(!s) return null; const p=s.split("-"); if(p.length!==2) return null; return new Date(parseInt(p[0]), parseInt(p[1])-1, 1);}

/* Categoria mapping via Descricao */
function mapCategoria(descRaw){
  const d = (descRaw||"").toUpperCase();
  if (d.includes("ESCOND") || d.includes("SLIM MV119")) return "Corredi√ßa Oculta";
  if (d.includes("TRILHO") && (d.includes("NORMAL") || d.includes("TELE") || d.includes("TELES"))) return "Corredi√ßa Telesc√≥pica";
  if (d.includes("DOBRAD")) return "Dobradi√ßas";
  if (d.includes("PIST") || d.includes("ARTICUL")) return "Articuladores";
  if (d.includes("RODIZ")) return "Rod√≠zio";
  if (d.includes("PULSADOR") || d.includes("TIP-ON") || d.includes("TIP ON")) return "Pulsadores";
  return "Acess√≥rios";
}

/* Normalize CSV rows */
function normalizeRows(rows){
  const out=[];
  rows.forEach(o=>{
    const ano = parseInt(o.Ano,10), mes = parseInt(o.Mes,10);
    if(!Number.isFinite(ano)||!Number.isFinite(mes)) return;
    out.push({
      Codigo: (o.Codigo||"").toString().trim(),
      Descricao: (o.Descricao||"").toString().trim(),
      Quantidade: Number(o.Quantidade)||0,
      Valor: Number(o.Valor)||0,
      Mes: mes, Ano: ano,
      Data: new Date(ano, mes-1, 1),
      Categoria: mapCategoria(o.Descricao)
    });
  });
  out.sort((a,b)=>a.Data-b.Data);
  return out;
}

/* Global monthly aggregation */
function aggMonthly(rows){
  const map = new Map();
  rows.forEach(r=>{
    const key = `${r.Ano}-${String(r.Mes).padStart(2,"0")}`;
    if(!map.has(key)) map.set(key,{Data:new Date(r.Ano,r.Mes-1,1), Valor:0, Quantidade:0});
    const m = map.get(key);
    m.Valor += r.Valor;
    m.Quantidade += r.Quantidade;
  });
  return Array.from(map.values()).sort((a,b)=>a.Data-b.Data);
}

/* Build labels only between the first and last REAL (non-zero) months */
function buildLabelsFromMonthly(monthly){
  if (!monthly.length) return [];
  const firstReal = monthly.find(r => (r.Valor > 0 || r.Quantidade > 0));
  const lastReal  = [...monthly].reverse().find(r => (r.Valor > 0 || r.Quantidade > 0));
  if (!firstReal || !lastReal) return [];
  const labels = [];
  let cur = new Date(firstReal.Data.getFullYear(), firstReal.Data.getMonth(), 1);
  const end = new Date(lastReal.Data.getFullYear(), lastReal.Data.getMonth(), 1);
  while (cur <= end) {
    labels.push(new Date(cur.getFullYear(), cur.getMonth(), 1).toISOString().slice(0, 10));
    cur = addMonths(cur, 1);
  }
  return labels;
}

/* Per-category monthly aggregation aligned to global labels */
function aggMonthlyByCategoryAligned(rows, labelDates){
  const cats = new Set(), byCatRaw={};
  rows.forEach(r=>{
    cats.add(r.Categoria);
    const cat=r.Categoria, key=`${r.Ano}-${String(r.Mes).padStart(2,"0")}`;
    if(!byCatRaw[cat]) byCatRaw[cat] = {};
    if(!byCatRaw[cat][key]) byCatRaw[cat][key] = {Data:new Date(r.Ano,r.Mes-1,1), Valor:0, Quantidade:0};
    byCatRaw[cat][key].Valor += r.Valor;
    byCatRaw[cat][key].Quantidade += r.Quantidade;
  });
  const data={};
  Array.from(cats).forEach(cat=>{
    data[cat] = labelDates.map(iso=>{
      const d=new Date(iso); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      const rec = byCatRaw[cat]?.[key];
      return {Data:new Date(d.getFullYear(), d.getMonth(), 1), Valor: rec?rec.Valor:0, Quantidade: rec?rec.Quantidade:0};
    });
  });
  return {cats:Array.from(cats), data};
}

/* Ticks: show all months */
function allMonthTicks(datesIso){
  const tickvals=[], ticktext=[];
  datesIso.forEach(iso=>{
    const dt = new Date(iso);
    tickvals.push(iso);
    ticktext.push(PT_ABBR[dt.getMonth()]+" "+String(dt.getFullYear()).slice(-2));
  });
  return {tickvals, ticktext};
}

/* Range Controls */
function applyRangeTo(divId, start, end){
  const gd = document.getElementById(divId);
  if(!gd) return;
  Plotly.relayout(gd, {'xaxis.range':[start, end]});
}
function quick(divId, key){
  const gd = document.getElementById(divId);
  if(!gd) return;
  let maxD = DATA_MAX, minD = DATA_MIN;
  let start, end = endOfMonth(maxD);
  if (key==='3M') start = startOfMonth(addMonths(maxD, -2));
  else if (key==='6M') start = startOfMonth(addMonths(maxD, -5));
  else if (key==='1A') start = startOfMonth(addMonths(maxD, -11));
  else if (key==='5A') start = startOfMonth(addMonths(maxD, -59));
  else if (key==='TUDO'){ start = startOfMonth(minD); end = endOfMonth(maxD); }
  else start = startOfMonth(addMonths(maxD, -11));
  applyRangeTo(divId, start, end);
  updateMetricsFor(divId);
}
function applyCustom(divId, fromId, toId){
  const f = document.getElementById(fromId).value;
  const t = document.getElementById(toId).value;
  const d1 = ymToDate(f), d2 = ymToDate(t);
  if(!d1 || !d2){ alert('Selecione m√™s/ano inicial e final.'); return; }
  applyRangeTo(divId, startOfMonth(d1), endOfMonth(d2));
  updateMetricsFor(divId);
}
function resetRange(divId){ quick(divId,'TUDO'); }

function wireRangeBar(barId){
  const bar = document.getElementById(barId);
  if(!bar) return;
  bar.querySelectorAll('.rbtn[data-range]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      bar.querySelectorAll('.rbtn[data-range]').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      quick(btn.dataset.target, btn.dataset.range);
    });
  });
}

/* Windowing & metrics */
function windowDataBy(divId, series){
  const gd = document.getElementById(divId);
  if(!gd || !series.length) return series;
  const r = gd.layout?.xaxis?.range;
  if(!r) return series;
  const from = new Date(r[0]), to = new Date(r[1]);
  return series.filter(o=> o.Data >= startOfMonth(from) && o.Data <= endOfMonth(to));
}
function computeMetrics(rows, key='Valor'){
  if(!rows.length) return {varTotal:"‚Äî", medMensal:"‚Äî", vol:"‚Äî"};
  const vals = rows.map(r=>r[key]||0);
  if(vals.length<2){
    return {
      varTotal:"‚Äî",
      medMensal: key==='Valor'? fmtBRL(vals[0]||0) : Math.round(vals[0]||0).toLocaleString('pt-BR'),
      vol:"‚Äî"
    };
  }
  const first = vals[0], last = vals[vals.length-1];
  const varTotal = (first===0)? 0 : ((last-first)/Math.abs(first))*100;
  const diffs = [];
  for(let i=1;i<vals.length;i++){
    diffs.push((vals[i-1]===0)?0: ((vals[i]-vals[i-1])/Math.abs(vals[i-1]))*100 );
  }
  const vol = diffs.length ? (diffs.reduce((a,b)=>a+Math.abs(b),0)/diffs.length) : 0;
  const medMensal = (vals.reduce((a,b)=>a+b,0)/vals.length);
  return {
    varTotal: (varTotal).toFixed(1).replace(".",",")+" %",
    medMensal: key==='Valor' ? fmtBRL(medMensal) : Math.round(medMensal).toLocaleString("pt-BR"),
    vol: vol.toFixed(1).replace(".",",")+" %"
  };
}

/* ====================== Drawers ====================== */
function drawTotal(){
  if(!MONTHLY.length) return;

  const x = MONTHLY.map(r=>r.Data.toISOString().slice(0,10));
  const {tickvals, ticktext} = allMonthTicks(x);

  const lineValor = {
    x,
    y: MONTHLY.map(r=>r.Valor),
    mode:'lines+markers',
    line:{shape:'spline',smoothing:.6,width:3,color:'var(--green)'},
    marker:{size:7,line:{width:1,color:'#fff'}},
    name:'Valor (R$)',
    yaxis:'y',
    hovertemplate:"<b>%{customdata.v}</b><extra></extra>",
    customdata: MONTHLY.map(r=>({v: fmtBRL(r.Valor)}))
  };

  const barsQtd = {
    x,
    y: MONTHLY.map(r=>r.Quantidade),
    type:'bar',
    marker:{color:'var(--orange)'},
    opacity:.95,
    name:'Quantidade (un.)',
    yaxis:'y2',
    hovertemplate:"<b>Quantidade: %{customdata.q}</b><extra></extra>",
    customdata: MONTHLY.map(r=>({q: Math.round(r.Quantidade).toLocaleString("pt-BR")}))
  };

  const layout = {
    ...baseLayout({tickvals, ticktext}, "Valor (R$)", "Quantidade (un.)"),
    yaxis:{...baseLayout({tickvals, ticktext},"Valor (R$)").yaxis, tick0:0, dtick:1_000_000, range:[0,5_000_000]}
  };

  // Draw line first so it stays above bars
  Plotly.newPlot('chart-total', [lineValor, barsQtd], layout, {responsive:true});

  DATA_MIN = MONTHLY[0].Data; DATA_MAX = MONTHLY[MONTHLY.length-1].Data;
  Plotly.relayout('chart-total', {'xaxis.range':[startOfMonth(DATA_MIN), endOfMonth(DATA_MAX)]});

  updateMetricsFor('chart-total');
  document.getElementById('chart-total').on('plotly_relayout', ()=>updateMetricsFor('chart-total'));
}

function drawRevenueLines(){
  const dates = MONTHLY_LABELS;
  const {tickvals, ticktext} = allMonthTicks(dates);

  const traces = CAT_ORDER.map(cat=>{
    const s = MONTHLY_BY_CAT[cat]||[];
    const map = new Map(s.map(r=>[r.Data.toISOString().slice(0,10), r]));
    const ys = dates.map(d=> (map.get(d)?.Valor)||0);
    const abbr = CAT_ABBR[cat]||cat;
    return {
      x: dates, y: ys, mode:'lines+markers',
      line:{shape:'spline',smoothing:.6,width:3,color:COLORS[cat]||'#666'},
      marker:{size:7,line:{width:1,color:'#fff'}},
      name: abbr+" (R$)", yaxis:'y',
      hovertemplate:"<b>"+abbr+": %{customdata.v}</b><extra></extra>",
      customdata: ys.map(v=>({v: fmtBRL(v)}))
    };
  });

  Plotly.newPlot('chart-fatlin', traces, baseLayout({tickvals,ticktext},"Valor (R$)"), {responsive:true});
  quick('chart-fatlin','TUDO');
  updateMetricsFor('chart-fatlin');
  document.getElementById('chart-fatlin').on('plotly_relayout', ()=>updateMetricsFor('chart-fatlin'));
}

function drawVolumeLines(){
  const dates = MONTHLY_LABELS;
  const {tickvals, ticktext} = allMonthTicks(dates);

  const traces = CAT_ORDER.map(cat=>{
    const s = MONTHLY_BY_CAT[cat]||[];
    const map = new Map(s.map(r=>[r.Data.toISOString().slice(0,10), r]));
    const ys = dates.map(d=> (map.get(d)?.Quantidade)||0);
    const abbr = CAT_ABBR[cat]||cat;
    return {
      x: dates, y: ys, mode:'lines+markers',
      line:{shape:'spline',smoothing:.6,width:3,color:COLORS[cat]||'#666'},
      marker:{size:7,line:{width:1,color:'#fff'}},
      name: abbr+" (un.)", yaxis:'y',
      hovertemplate:"<b>"+abbr+": %{customdata.q} un</b><extra></extra>",
      customdata: ys.map(v=>({q: Math.round(v).toLocaleString('pt-BR')}))
    };
  });

  Plotly.newPlot('chart-vollin', traces, baseLayout({tickvals,ticktext},"Quantidade (un.)"), {responsive:true});
  quick('chart-vollin','TUDO');
  updateMetricsFor('chart-vollin', false);
  document.getElementById('chart-vollin').on('plotly_relayout', ()=>updateMetricsFor('chart-vollin', false));
}

/* Participa√ß√£o (%) por Linha - stacked percent bars */
function drawShare(){
  const dates = MONTHLY_LABELS;
  const {tickvals, ticktext} = allMonthTicks(dates);

  const byDateTotals = dates.map((d,i)=>{
    let total = 0;
    CAT_ORDER.forEach(cat=>{
      const rec = MONTHLY_BY_CAT[cat]?.[i];
      total += rec ? rec.Valor : 0;
    });
    return total;
  });

  const traces = CAT_ORDER.map(cat=>{
    const s = MONTHLY_BY_CAT[cat]||[];
    const ys = dates.map((d,i)=>{
      const rec = s[i];
      return rec ? rec.Valor : 0;
    });
    const abbr = CAT_ABBR[cat]||cat;
    return {
      x: dates, y: ys, type:'bar', marker:{color: COLORS[cat]||'#666'}, name: abbr,
      hovertemplate:"<b>"+abbr+": %{customdata.p}%</b><extra></extra>",
      customdata: ys.map((v,idx)=>{
        const tot = byDateTotals[idx]||0;
        const pct = tot>0 ? (v/tot*100) : 0;
        return {p: pct.toFixed(1).replace('.',',')};
      })
    };
  });

  const layout = baseLayout({tickvals,ticktext}, "Participa√ß√£o no Valor (%)");
  layout.barmode='stack';
  layout.barnorm='percent';
  layout.yaxis.range=[0,1];

  Plotly.newPlot('chart-share', traces, layout, {responsive:true});
  quick('chart-share','TUDO');

  updateShareMetrics();
  document.getElementById('chart-share').on('plotly_relayout', ()=>updateShareMetrics());
}

/* Desempenho por Linha (cards) */
function buildCategoryCards(containerId){
  const container = document.getElementById(containerId);
  const order = CAT_ORDER;
  container.innerHTML = order.map(cat=>{
    const safe = cat.replace(/\s+/g,'-').toLowerCase();
    return `
      <div class="section" style="margin:8px 0;">
        <div class="titlebar collapsible" data-target="card-${safe}">
          <span>${cat}</span><span class="caret">‚ñ∂</span>
        </div>
        <div id="card-${safe}" class="card-wrap" style="max-height:0;overflow:hidden">
          <div class="card">
            <div class="rangebar" id="range-${safe}">
              <button class="rbtn" data-target="chart-${safe}" data-range="3M">3M</button>
              <button class="rbtn" data-target="chart-${safe}" data-range="6M">6M</button>
              <button class="rbtn" data-target="chart-${safe}" data-range="1A">1A</button>
              <button class="rbtn" data-target="chart-${safe}" data-range="5A">5A</button>
              <button class="rbtn active" data-target="chart-${safe}" data-range="TUDO">Tudo</button>
              <span style="margin-left:8px;">De</span>
              <input type="month" id="from-${safe}"/>
              <span>at√©</span>
              <input type="month" id="to-${safe}"/>
              <button class="rbtn" onclick="applyCustom('chart-${safe}','from-${safe}','to-${safe}')">Aplicar</button>
              <button class="rbtn" onclick="resetRange('chart-${safe}')">Reset</button>
            </div>
            <div class="metrics">
              <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-${safe}">‚Äî</div></div>
              <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-${safe}">‚Äî</div></div>
              <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-${safe}">‚Äî</div></div>
            </div>
            <div class="chart" id="chart-${safe}"></div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  container.querySelectorAll('.titlebar.collapsible').forEach(tb=>{
    tb.addEventListener('click', ()=>{
      const id = tb.getAttribute('data-target');
      const wrap = document.getElementById(id);
      const open = (!wrap.style.maxHeight || wrap.style.maxHeight==='0px');
      if (open){
        const chartId = id.replace('card-','chart-');
        drawCategory(chartId);
        wrap.style.maxHeight = 'none';
        wrap.style.overflow = 'visible';
      } else {
        wrap.style.maxHeight = '0';
        wrap.style.overflow = 'hidden';
      }
      const caret = tb.querySelector('.caret');
      if (caret) caret.textContent = open ? '‚ñº' : '‚ñ∂';
    });
  });

  order.forEach(cat=>{
    const safe = cat.replace(/\s+/g,'-').toLowerCase();
    wireRangeBar(`range-${safe}`);
  });
}

function drawCategory(chartId){
  const catKey = chartId.replace('chart-','').replace(/-/g,' ');
  const proper = CAT_ORDER.find(c=> c.toLowerCase()===catKey);
  if(!proper) return;

  const s = MONTHLY_BY_CAT[proper]||[];
  const x = s.map(r=>r.Data.toISOString().slice(0,10));
  const {tickvals,ticktext} = allMonthTicks(x);

  const valor = {
    x, y: s.map(r=>r.Valor),
    mode:'lines+markers',
    line:{shape:'spline',smoothing:.6,width:3,color:'var(--green)'},
    marker:{size:7,line:{width:1,color:'#fff'}},
    name:"Valor (R$)", yaxis:"y",
    hovertemplate:"<b>%{customdata.v}</b><extra></extra>",
    customdata: s.map(r=>({v: fmtBRL(r.Valor)}))
  };
  const qtd = {
    x, y: s.map(r=>r.Quantidade),
    type:'bar', marker:{color:'var(--orange)'}, opacity:.95,
    name:"Quantidade (un.)", yaxis:"y2",
    hovertemplate:"<b>Quantidade: %{customdata.q}</b><extra></extra>",
    customdata: s.map(r=>({q: Math.round(r.Quantidade).toLocaleString('pt-BR')}))
  };

  Plotly.newPlot(chartId, [valor, qtd],
    baseLayout({tickvals,ticktext},"Valor (R$)","Quantidade (un.)"),
    {responsive:true}
  );

  quick(chartId,'TUDO');
  updateMetricsFor(chartId);
  document.getElementById(chartId).on('plotly_relayout', ()=>updateMetricsFor(chartId));
}

/* Base layout helper */
function baseLayout(xTicks, yTitleL, yTitleR=null){
  const tf = isMobile()?10:12;
  const lay = {
    hovermode:'x unified',
    legend:{orientation:'h', y:-0.25, font:{size:isMobile()?11:12}},
    xaxis:{showgrid:false, tickmode:'array', ...xTicks, tickfont:{size:tf}, automargin:true},
    yaxis:{gridcolor:'#e9ecef', zeroline:false, title:yTitleL, tickfont:{size:tf}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff',
    margin:{t:20,r:30,b:80,l:60},
    hoverlabel:{bgcolor:'#fff', bordercolor:'#ccc', font:{size:isMobile()?11:12}}
  };
  if (yTitleR){
    lay.yaxis2 = {title:yTitleR, overlaying:'y', side:'right', tickfont:{size:tf}, automargin:true};
  }
  return lay;
}

/* Share metrics */
function updateShareMetrics(){
  const gd = document.getElementById('chart-share');
  if(!gd) return;
  const r = gd.layout?.xaxis?.range;
  const dates = MONTHLY_LABELS.map(s=>new Date(s));
  const from = r? new Date(r[0]) : dates[0];
  const to   = r? new Date(r[1]) : dates[dates.length-1];
  const idxInRange = MONTHLY_LABELS.map((s,i)=> {
    const d = dates[i];
    return (d>=startOfMonth(from)&& d<=endOfMonth(to)) ? i : -1;
  }).filter(i=>i>=0);

  if(!idxInRange.length) return;

  const avg = {};
  let lastIdx = idxInRange[idxInRange.length-1];
  let lastTotals = 0;
  CAT_ORDER.forEach(cat=>{ avg[cat]=0; });
  idxInRange.forEach(i=>{
    let total=0; CAT_ORDER.forEach(cat=>{ total += MONTHLY_BY_CAT[cat]?.[i]?.Valor||0;});
    if (i===lastIdx) lastTotals = total;
    CAT_ORDER.forEach(cat=>{
      const v = MONTHLY_BY_CAT[cat]?.[i]?.Valor||0;
      avg[cat] += total>0 ? (v/total) : 0;
    });
  });
  CAT_ORDER.forEach(cat=>{ avg[cat] = (avg[cat]/idxInRange.length)*100; });

  let bestCat=null, bestPct=-1;
  CAT_ORDER.forEach(cat=>{
    const v = MONTHLY_BY_CAT[cat]?.[lastIdx]?.Valor||0;
    const pct = lastTotals>0 ? (v/lastTotals*100) : 0;
    if (pct>bestPct){bestPct=pct; bestCat=cat;}
  });

  document.getElementById('max-share').textContent =
    `${CAT_ABBR[bestCat]||bestCat} (${bestPct.toFixed(1).replace('.',',')}%)`;

  let bestAvgCat = Object.entries(avg).sort((a,b)=>b[1]-a[1])[0];
  if (bestAvgCat){
    document.getElementById('avg-share').textContent =
      `${CAT_ABBR[bestAvgCat[0]]||bestAvgCat[0]} (${bestAvgCat[1].toFixed(1).replace('.',',')}%)`;
  }

  const mean = Object.values(avg).reduce((a,b)=>a+b,0)/Object.values(avg).length;
  const variance = Object.values(avg).reduce((a,b)=>a+(b-mean)*(b-mean),0)/Object.values(avg).length;
  const std = Math.sqrt(variance);
  document.getElementById('vol-share').textContent = std.toFixed(1).replace('.',',')+" %";
}

/* Metrics updaters */
function updateMetricsFor(divId){
  if (divId==='chart-total'){
    const subset = windowDataBy('chart-total', MONTHLY);
    const m = computeMetrics(subset,'Valor');
    document.getElementById('var-total').textContent = m.varTotal;
    document.getElementById('med-total').textContent = m.medMensal;
    document.getElementById('vol-total').textContent = m.vol;
  } else if (divId==='chart-fatlin'){
    const subset = windowDataBy('chart-fatlin', MONTHLY);
    const m = computeMetrics(subset,'Valor');
    document.getElementById('var-fatlin').textContent = m.varTotal;
    document.getElementById('med-fatlin').textContent = m.medMensal;
    document.getElementById('vol-fatlin').textContent = m.vol;
  } else if (divId==='chart-vollin'){
    const subset = windowDataBy('chart-vollin', MONTHLY);
    const m = computeMetrics(subset,'Quantidade');
    document.getElementById('var-vollin').textContent = m.varTotal;
    document.getElementById('med-vollin').textContent = m.medMensal;
    document.getElementById('vol-vollin').textContent = m.vol;
  } else if (divId==='chart-share'){
    updateShareMetrics();
  } else if (divId.startsWith('chart-')){
    const catKey = divId.replace('chart-','').replace(/-/g,' ');
    const proper = CAT_ORDER.find(c=> c.toLowerCase()===catKey);
    const safe = proper.replace(/\s+/g,'-').toLowerCase();
    const subset = windowDataBy(divId, MONTHLY_BY_CAT[proper]||[]);
    const m = computeMetrics(subset,'Valor');
    document.getElementById(`var-${safe}`).textContent = m.varTotal;
    document.getElementById(`med-${safe}`).textContent = m.medMensal;
    document.getElementById(`vol-${safe}`).textContent = m.vol;
  }
}

/* ====================== Boot ====================== */
async function initDashboard(){
  const overlay = document.getElementById("loading-overlay");
  try {
    const res = await fetch('./data/relatorio_faturamento.csv');
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    RAW_ROWS = normalizeRows(parsed.data);

    if (!RAW_ROWS.length) {
      console.error("‚ö†Ô∏è CSV carregado sem linhas v√°lidas.");
      return;
    }

    // Aggregations + labels bounded by real data only
    MONTHLY = aggMonthly(RAW_ROWS);
    MONTHLY_LABELS = buildLabelsFromMonthly(MONTHLY); // ‚úÖ first..last month with real data
    const bycat = aggMonthlyByCategoryAligned(RAW_ROWS, MONTHLY_LABELS);
    CATS = bycat.cats;
    MONTHLY_BY_CAT = bycat.data;

    // Updated label (last real month)
    const lastIdx = MONTHLY_LABELS.length-1;
    const maxD = new Date(MONTHLY_LABELS[lastIdx]);
    document.getElementById("updated").textContent =
      "Atualizado: " + PT_ABBR[maxD.getMonth()] + "/" + maxD.getFullYear();

    // Category order
    const mainSet = ["Corredi√ßa Oculta","Corredi√ßa Telesc√≥pica","Dobradi√ßas","Articuladores","Rod√≠zio","Pulsadores"];
    const others = CATS.filter(c => !mainSet.includes(c) && c!=="Acess√≥rios");
    CAT_ORDER = [...mainSet.filter(c=>CATS.includes(c)), ...(CATS.includes("Acess√≥rios")?["Acess√≥rios"]:[]), ...others];

    // Global date bounds (for quick ranges)
    DATA_MIN = new Date(MONTHLY_LABELS[0]); DATA_MAX = new Date(MONTHLY_LABELS[lastIdx]);

    // Draw sections
    drawTotal();
    drawRevenueLines();
    drawVolumeLines();
    drawShare();
    buildCategoryCards("cats-container");

    // Wire range bars
    ["range-total","range-fatlin","range-vollin","range-share"].forEach(wireRangeBar);

    // Collapsibles (top level) with natural height (no cutoff)
    document.querySelectorAll('.titlebar.collapsible').forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.getAttribute('data-target');
        const wrap = document.getElementById(id);
        const open = (!wrap.style.maxHeight || wrap.style.maxHeight==='0px');
        if (open){
          wrap.style.maxHeight = 'none';
          wrap.style.overflow = 'visible';
        } else {
          wrap.style.maxHeight = '0';
          wrap.style.overflow = 'hidden';
        }
        const caret = el.querySelector('.caret');
        if (caret) caret.textContent = open ? '‚ñº' : '‚ñ∂';
      });
    });

    // Fade out loader
    setTimeout(()=> overlay.classList.add('hidden'), 600);
  } catch (err) {
    console.error("‚ùå Erro ao carregar:", err);
    if (overlay) overlay.querySelector(".loading-text").textContent = "Erro ao carregar dados.";
  }
}

document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
